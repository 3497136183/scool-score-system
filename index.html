<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜æ ¡å­¦ç”Ÿæ—¥å¸¸è¡¨ç°é‡åŒ–ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; }
        body { background-color: #f5f7fa; color: #333; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background-color: #2c3e50; color: white; padding: 20px 0; text-align: center; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { font-size: 28px; margin-bottom: 10px; }
        .subtitle { font-size: 16px; opacity: 0.8; }
        .login-section, .management-section { background-color: white; border-radius: 8px; padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h2 { color: #2c3e50; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #ecf0f1; }
        h3 { margin-top: 20px; margin-bottom: 10px; color: #2c3e50; }
        h4 { margin-top: 15px; margin-bottom: 10px; color: #34495e; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #34495e; }
        input, select, button, textarea { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 2px rgba(52,152,219,0.2); }
        button { background-color: #3498db; color: white; border: none; cursor: pointer; font-weight: 600; transition: background-color 0.3s; }
        button:hover { background-color: #2980b9; }
        .logout-btn { background-color: #e74c3c; width: auto; padding: 10px 20px; margin-top: 20px; }
        .logout-btn:hover { background-color: #c0392b; }
        .page-selector { display: flex; justify-content: center; margin-bottom: 30px; }
        .page-btn { padding: 12px 30px; margin: 0 10px; background-color: #ecf0f1; color: #7f8c8d; border: 2px solid #bdc3c7; border-radius: 4px; font-weight: 600; cursor: pointer; transition: all 0.3s; width: auto; }
        .page-btn.active { background-color: #3498db; color: white; border-color: #3498db; }
        .page-btn:hover:not(.active) { background-color: #d5dbdb; }
        .page { display: none; }
        .page.active { display: block; }
        .student-info { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 25px; background-color: #f8f9fa; padding: 15px; border-radius: 6px; }
        .info-item { flex: 1; min-width: 200px; }
        .score-summary { display: flex; justify-content: space-between; margin-bottom: 30px; }
        .summary-card { background-color: white; border-radius: 6px; padding: 20px; text-align: center; flex: 1; margin: 0 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-top: 4px solid #3498db; }
        .summary-card h3 { font-size: 14px; color: #7f8c8d; margin-bottom: 10px; }
        .summary-card .score { font-size: 32px; font-weight: 700; color: #2c3e50; }
        .score-table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-radius: 6px; overflow: hidden; }
        .score-table th, .score-table td { border: 1px solid #ecf0f1; padding: 15px; text-align: center; }
        .score-table th { background-color: #2c3e50; color: white; font-weight: 600; }
        .score-table tr:nth-child(even) { background-color: #f8f9fa; }
        .positive-score { color: #27ae60; font-weight: 600; }
        .negative-score { color: #e74c3c; font-weight: 600; }
        .history-section { margin-top: 30px; }
        .history-controls { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .history-controls input, .history-controls select { flex: 1; min-width: 160px; }
        .history-controls button { width: auto; min-width: 100px; }
        .history-table { width: 100%; border-collapse: collapse; background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-radius: 6px; overflow: hidden; margin-top:10px; }
        .history-table th, .history-table td { border: 1px solid #ecf0f1; padding: 12px; text-align: center; }
        .history-table th { background-color: #34495e; color: white; }
        .history-table tr:nth-child(even) { background-color: #f8f9fa; }
        .school-management { display: grid; grid-template-columns: 300px 1fr; gap: 30px; }
        .class-list { background-color: white; border-radius: 6px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); max-height: 500px; overflow-y: auto; }
        .class-item { padding: 12px 15px; border-bottom: 1px solid #ecf0f1; cursor: pointer; transition: background-color 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .class-item:hover { background-color: #f8f9fa; }
        .class-item.active { background-color: #e3f2fd; border-left: 4px solid #3498db; }
        .del-class-btn { background: #e74c3c; color: #fff; border: none; padding: 4px 10px; border-radius: 4px; font-size: 12px; }
        .del-class-btn:hover { background: #c0392b; }
        .student-editor { background-color: white; border-radius: 6px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .form-row { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
        .form-field { flex: 1; min-width: 200px; }
        .action-buttons { display: flex; gap: 15px; margin-top: 30px; flex-wrap:wrap; }
        .save-btn { background-color: #27ae60; }
        .save-btn:hover { background-color: #219653; }
        .delete-btn { background-color: #e74c3c; }
        .delete-btn:hover { background-color: #c0392b; }
        .add-btn { background-color: #9b59b6; margin-bottom: 15px; }
        .add-btn:hover { background-color: #8e44ad; }
        .batch-add-btn { background-color: #f39c12; margin-bottom: 15px; }
        .batch-add-btn:hover { background-color: #d35400; }
        .batch-delete-btn { background-color: #c0392b; margin-bottom: 15px; }
        .identity-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; color: white; }
        .identity-student { background-color: #3498db; }
        .identity-monitor { background-color: #2ecc71; }
        .identity-instructor { background-color: #9b59b6; }
        .identity-battalion-chief { background-color: #e67e22; }
        .identity-deputy-instructor { background-color: #1abc9c; }
        .identity-deputy-battalion-chief { background-color: #d35400; }
        .identity-company-commander { background-color: #e74c3c; }
        .identity-guidance-instructor { background-color: #34495e; }
        .identity-admin { background-color: #8e44ad; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 6px; color: white; font-weight: 600; z-index: 1000; opacity: 0; transform: translateX(100%); transition: all 0.3s; }
        .notification.show { opacity: 1; transform: translateX(0); }
        .notification.success { background-color: #27ae60; }
        .notification.error { background-color: #e74c3c; }
        .notification.info { background-color: #3498db; }
        .hidden { display: none; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; border-radius: 8px; padding: 25px; width: 90%; max-width: 500px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #ecf0f1; }
        .modal-title { font-size: 20px; color: #2c3e50; }
        .close-modal { background: none; border: none; font-size: 24px; color: #7f8c8d; cursor: pointer; width: auto; padding: 0; }
        .close-modal:hover { color: #e74c3c; }
        .admin-notice { background: #e3f2fd; color: #1976d2; padding: 10px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #1976d2; }
        .online-students { margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 6px; }
        .online-students ul { list-style: none; padding-left: 0; }
        .online-students li { padding: 4px 0; color: #27ae60; }
        .admin-score-preview { margin-top: 25px; padding-top: 20px; border-top: 2px solid #ecf0f1; }
        .today-total { font-size: 18px; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .sync-status { position: fixed; bottom: 20px; right: 20px; background: #3498db; color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; z-index: 1000; }
        .sync-status.offline { background: #e74c3c; }
        .sync-status.syncing { background: #f39c12; }
        .data-status { position: fixed; bottom: 20px; left: 20px; background: #2c3e50; color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; z-index: 1000; }
        @media (max-width: 768px) { .school-management { grid-template-columns: 1fr; } .score-summary { flex-direction: column; } .summary-card { margin: 10px 0; } .action-buttons { flex-direction: column; } }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>é«˜æ ¡å­¦ç”Ÿæ—¥å¸¸è¡¨ç°é‡åŒ–ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ</h1>
        <p class="subtitle">äº‘ç«¯å¤šäººåä½œ Â· æ•°æ®å®æ—¶åŒæ­¥ Â· åŸºç¡€åˆ†è‡ªåŠ¨åŠ æ»¡ï¼ˆå€¼ç­=0ï¼‰</p>
    </header>

    <div class="page-selector">
        <button id="studentPageBtn" class="page-btn active">å­¦ç”ŸæŸ¥è¯¢é¡µé¢</button>
        <button id="schoolPageBtn" class="page-btn">å­¦æ ¡ç®¡ç†é¡µé¢</button>
    </div>

    <!-- å­¦ç”ŸæŸ¥è¯¢é¡µé¢ -->
    <div id="studentPage" class="page active">
        <div class="login-section">
            <h2>å­¦ç”Ÿåˆ†æ•°æŸ¥è¯¢</h2>
            <div class="form-group">
                <label for="studentClass">â‘  é€‰æ‹©ä½ çš„ç­çº§</label>
                <select id="studentClass" style="font-size:17px; font-weight:500;">
                    <option value="">-- ç‚¹æ­¤é€‰æ‹©ç­çº§ --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="studentId">â‘¡ è¾“å…¥ä½ çš„å­¦å·</label>
                <input type="text" id="studentId" placeholder="è¯·è¾“å…¥ä½ çš„å­¦å·" style="font-size:17px;">
            </div>
            <button id="studentLoginBtn" style="font-size:18px; padding:14px;">â‘¢ ç‚¹å‡»æŸ¥è¯¢åˆ†æ•°</button>
        </div>

        <div id="studentInfoSection" class="management-section hidden">
            <div id="adminActionNotice" class="admin-notice hidden">ç®¡ç†å‘˜åˆšåˆšæ›´æ–°äº†ä½ çš„æ•°æ®</div>
            <h2>æˆ‘çš„ä¿¡æ¯</h2>
            <div class="student-info">
                <div class="info-item"><label>å§“å</label><div id="displayName">--</div></div>
                <div class="info-item"><label>å­¦å·</label><div id="displayStudentId">--</div></div>
                <div class="info-item"><label>ç­çº§</label><div id="displayClass">--</div></div>
                <div class="info-item"><label>èº«ä»½</label><div id="displayIdentity">--</div></div>
            </div>

            <div class="score-summary">
                <div class="summary-card"><h3>ä»Šæ—¥æ€»åˆ†</h3><div class="score" id="todayTotal">0</div></div>
                <div class="summary-card"><h3>æœ¬æœˆæ€»åˆ†</h3><div class="score" id="monthlyTotal">0</div></div>
                <div class="summary-card"><h3>ç´¯è®¡æ€»åˆ†</h3><div class="score" id="totalScore">0</div></div>
            </div>

            <h3>å½“æ—¥é‡åŒ–ç§¯åˆ†æ˜ç»†</h3>
            <table class="score-table" id="studentScoreTable">
                <thead id="studentScoreHeader"></thead>
                <tbody id="studentScoreBody"></tbody>
            </table>

            <!-- å†å²æ¯æ—¥æ˜ç»† -->
            <div class="history-section">
                <h3>å†å²æ¯æ—¥æ˜ç»†æŸ¥è¯¢</h3>
                <div class="history-controls">
                    <input type="date" id="historyDateInput">
                    <button id="queryHistoryBtn">æŸ¥è¯¢å½“æ—¥æ˜ç»†</button>
                </div>
                <table class="history-table" id="historyDetailTable">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- å†å²æ¯æœˆæ€»åˆ†æŸ¥è¯¢ -->
            <div class="history-section">
                <h3>å†å²æ¯æœˆæ€»åˆ†æŸ¥è¯¢</h3>
                <div class="history-controls">
                    <select id="historyMonthSelect">
                        <option value="">-- é€‰æ‹©æœˆä»½ --</option>
                    </select>
                    <button id="queryMonthTotalBtn">æŸ¥è¯¢å½“æœˆæ€»åˆ†</button>
                </div>
                <table class="history-table" id="monthTotalTable">
                    <thead><tr><th>æœˆä»½</th><th>å½“æœˆæ€»åˆ†</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <button class="logout-btn" id="studentLogoutBtn">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <!-- å­¦æ ¡ç®¡ç†é¡µé¢ -->
    <div id="schoolPage" class="page">
        <div class="login-section">
            <h2>å­¦æ ¡ç®¡ç†å‘˜ç™»å½•</h2>
            <div class="form-group">
                <label for="adminUsername">ç”¨æˆ·å</label>
                <input type="text" id="adminUsername" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜ç”¨æˆ·å">
            </div>
            <div class="form-group">
                <label for="adminPassword">å¯†ç </label>
                <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
            </div>
            <button id="adminLoginBtn">ç®¡ç†å‘˜ç™»å½•</button>
        </div>

        <div id="schoolManagementSection" class="management-section hidden">
            <h2>å­¦æ ¡ç®¡ç†é¢æ¿</h2>
            <div class="school-management">
                <div class="class-list">
                    <h3>ç­çº§åˆ—è¡¨</h3>
                    <button class="add-btn" id="addClassBtn">+ æ·»åŠ æ–°ç­çº§</button>
                    <button class="batch-add-btn" id="batchAddClassBtn">+ æ‰¹é‡å¯¼å…¥ç­çº§</button>
                    <div id="classListContainer"></div>
                </div>

                <div class="student-editor">
                    <h3>å­¦ç”Ÿ/ç”¨æˆ·ç®¡ç†</h3>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="editClass">ç­çº§</label>
                            <select id="editClass"><option value="">-- è¯·é€‰æ‹©ç­çº§ --</option></select>
                        </div>
                        <div class="form-field">
                            <label for="editStudentId">å­¦å·/å·¥å·</label>
                            <input type="text" id="editStudentId" placeholder="è¾“å…¥å­¦å·æˆ–å·¥å·">
                        </div>
                        <div class="form-field">
                            <label for="editName">å§“å</label>
                            <input type="text" id="editName" placeholder="è¾“å…¥å§“å">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-field">
                            <label for="editIdentity">èº«ä»½</label>
                            <select id="editIdentity">
                                <option value="å­¦ç”Ÿ">å­¦ç”Ÿ</option>
                                <option value="ç­é•¿">ç­é•¿</option>
                                <option value="è¿é•¿">è¿é•¿</option>
                                <option value="æŒ‡å¯¼å‘˜">æŒ‡å¯¼å‘˜</option>
                                <option value="å‰¯è¥é•¿">å‰¯è¥é•¿</option>
                                <option value="è¥é•¿">è¥é•¿</option>
                                <option value="å‰¯æ•™å¯¼å‘˜">å‰¯æ•™å¯¼å‘˜</option>
                                <option value="æ•™å¯¼å‘˜">æ•™å¯¼å‘˜</option>
                                <option value="ç®¡ç†å‘˜">ç®¡ç†å‘˜</option>
                            </select>
                        </div>
                    </div>

                    <h4>åŸºç¡€åŠ åˆ†é¡¹ï¼ˆå€¼ç­=0ï¼Œä¸è‡ªåŠ¨åŠ åˆ†ï¼‰</h4>
                    <div class="form-row">
                        <div class="form-field"><label for="editMorningExercise">æ—©æ“(10)</label><input type="number" id="editMorningExercise" min="0" max="10" value="0"></div>
                        <div class="form-field"><label for="editClassAttendance">ä¸Šè¯¾(10)</label><input type="number" id="editClassAttendance" min="0" max="10" value="0"></div>
                        <div class="form-field"><label for="editTraining">å®è®­(10)</label><input type="number" id="editTraining" min="0" max="10" value="0"></div>
                        <div class="form-field"><label for="editPhysicalTraining">ä½“èƒ½è®­ç»ƒ(10)</label><input type="number" id="editPhysicalTraining" min="0" max="10" value="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-field"><label for="editRollCall">ç‚¹å(10)</label><input type="number" id="editRollCall" min="0" max="10" value="0"></div>
                        <div class="form-field"><label for="editDuty">å€¼ç­(10)</label><input type="number" id="editDuty" min="0" max="10" value="0"></div>
                    </div>

                    <h4>å¥–åŠ±åŠ åˆ†é¡¹</h4>
                    <div class="form-row">
                        <div class="form-field"><label for="editSchoolAward">æ ¡å†…å¥–(10)</label><input type="number" id="editSchoolAward" min="0" max="10" value="0"></div>
                        <div class="form-field"><label for="editProvincialAward">çœçº§å¥–(20)</label><input type="number" id="editProvincialAward" min="0" max="20" value="0"></div>
                        <div class="form-field"><label for="editStarAward">å›½çº§å¥–(40)</label><input type="number" id="editStarAward" min="0" max="40" value="0"></div>
                        <div class="form-field"><label for="editAdminBonus">ç®¡ç†å‘˜åŠ åˆ†(50)</label><input type="number" id="editAdminBonus" min="0" max="50" value="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-field"><label for="editVolunteer">å¿—æ„¿è€…(10)</label><input type="number" id="editVolunteer" min="0" max="10" value="0"></div>
                        <div class="form-field"><label for="editGoodDeed">å¥½äººå¥½äº‹(10)</label><input type="number" id="editGoodDeed" min="0" max="10" value="0"></div>
                    </div>

                    <h4>æ‰£åˆ†é¡¹</h4>
                    <div class="form-row">
                        <div class="form-field"><label for="editUniformViolation">å†›å®¹ä¸æ•´(30)</label><input type="number" id="editUniformViolation" min="0" max="30" value="0"></div>
                        <div class="form-field"><label for="editPhoneViolation">è¿è§„ä½¿ç”¨æ‰‹æœº(50)</label><input type="number" id="editPhoneViolation" min="0" max="50" value="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-field"><label for="editComputerViolation">è¿è§„ä½¿ç”¨ç”µè„‘(50)</label><input type="number" id="editComputerViolation" min="0" max="50" value="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-field"><label for="editSmokingViolation">è¿è§„æŠ½çƒŸ(25)</label><input type="number" id="editSmokingViolation" min="0" max="25" value="0"></div>
                        <div class="form-field"><label for="editNightAbsence">å¤œä¸å½’å®¿(25)</label><input type="number" id="editNightAbsence" min="0" max="25" value="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-field"><label for="editLateRise">æœªåŠæ—¶èµ·åºŠ(25)</label><input type="number" id="editLateRise" min="0" max="25" value="0"></div>
                        <div class="form-field"><label for="editUntimelyLeave">æœªåŠæ—¶è¯·å‡é”€å‡(25)</label><input type="number" id="editUntimelyLeave" min="0" max="25" value="0"></div>
                    </div>

                    <div class="admin-score-preview">
                        <h4>ğŸ“Š è¯¥ç”Ÿå½“æ—¥åˆ†æ•°å®æ—¶é¢„è§ˆ</h4>
                        <div class="today-total">å½“æ—¥æ€»åˆ†ï¼š<span id="adminTodayTotal" class="positive-score">0</span></div>
                        <table class="score-table" id="adminScorePreviewTable">
                            <thead>
                                <tr>
                                    <th>è¯„åˆ†é¡¹ç›®</th>
                                    <th>å½“å‰åˆ†æ•°</th>
                                </tr>
                            </thead>
                            <tbody id="adminScorePreviewBody"></tbody>
                        </table>
                    </div>

                    <div class="action-buttons">
                        <button class="save-btn" id="saveStudentBtn">ä¿å­˜ç”¨æˆ·ä¿¡æ¯</button>
                        <button class="delete-btn" id="deleteStudentBtn">åˆ é™¤è¯¥ç”¨æˆ·</button>
                        <button class="add-btn" id="addStudentBtn">æ·»åŠ æ–°ç”¨æˆ·</button>
                        <button class="batch-delete-btn" id="batchDeleteStudentsBtn">æ‰¹é‡åˆ é™¤è¯¥ç­ç”¨æˆ·</button>
                    </div>
                </div>
            </div>

            <div class="online-students">
                <h3>å½“å‰åœ¨çº¿å­¦ç”Ÿ</h3>
                <ul id="onlineStudentsList"></ul>
            </div>

            <button class="logout-btn" id="adminLogoutBtn">é€€å‡ºç®¡ç†å‘˜ç™»å½•</button>
        </div>
    </div>

    <!-- æ‰¹é‡å¯¼å…¥ç­çº§æ¨¡æ€æ¡† -->
    <div id="batchAddModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ‰¹é‡å¯¼å…¥ç­çº§</h3>
                <button class="close-modal" id="closeBatchModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="batchClassNames">ç­çº§åç§°ï¼ˆæ¯è¡Œä¸€ä¸ªç­çº§ï¼‰</label>
                <textarea id="batchClassNames" rows="8" placeholder="è®¡ç®—æœº1ç­&#10;è½¯ä»¶2ç­"></textarea>
            </div>
            <div class="action-buttons">
                <button class="save-btn" id="confirmBatchAdd">ç¡®è®¤å¯¼å…¥</button>
                <button class="delete-btn" id="cancelBatchAdd">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>
    <div id="syncStatus" class="sync-status">å·²è¿æ¥äº‘ç«¯</div>
    <div id="dataStatus" class="data-status">æ•°æ®å·²åŒæ­¥</div>
</div>

<script>
    // é…ç½®å¸¸é‡
    // é‡è¦ï¼šéƒ¨ç½²åˆ°Vercelåï¼Œå°†è¿™é‡Œçš„URLæ›¿æ¢ä¸ºä½ çš„å®é™…VercelåŸŸå
    const API_BASE_URL = '/api';    
    const STORAGE_KEY = 'school_data_v3';
    const LAST_RUN_DATE = 'lastAutoDate';
    const SYNC_INTERVAL = 30000; // 30ç§’åŒæ­¥ä¸€æ¬¡
    const MAX_RETRY = 3; // æœ€å¤§é‡è¯•æ¬¡æ•°

    let schoolData = { classes: [] };
    let currentState = {
        studentLoggedIn: false, 
        currentStudent: null, 
        currentStudentClass: null,
        adminLoggedIn: false, 
        currentClassId: null
    };

    let onlineStudents = [];
    let syncTimer = null;
    let isOnline = true;
    let retryCount = 0;
    let lastSyncTime = null;

    const IDENTITY_TYPES = {
        'å­¦ç”Ÿ':'identity-student',
        'ç­é•¿':'identity-monitor',
        'è¿é•¿':'identity-company-commander',
        'æŒ‡å¯¼å‘˜':'identity-guidance-instructor',
        'å‰¯è¥é•¿':'identity-deputy-battalion-chief',
        'è¥é•¿':'identity-battalion-chief',
        'å‰¯æ•™å¯¼å‘˜':'identity-deputy-instructor',
        'æ•™å¯¼å‘˜':'identity-instructor',
        'ç®¡ç†å‘˜':'identity-admin'
    };

    const AUTO_BASE = {
        morningExercise: 10,
        classAttendance: 10,
        training: 10,
        physicalTraining: 10,
        rollCall: 10,
        duty: 0
    };

    const SCORE_FIELDS = [
        {key:'morningExercise',label:'æ—©æ“'},
        {key:'classAttendance',label:'ä¸Šè¯¾'},
        {key:'training',label:'å®è®­'},
        {key:'physicalTraining',label:'ä½“èƒ½è®­ç»ƒ'},
        {key:'rollCall',label:'ç‚¹å'},
        {key:'duty',label:'å€¼ç­'},
        {key:'schoolAward',label:'æ ¡å†…å¥–'},
        {key:'provincialAward',label:'çœçº§å¥–'},
        {key:'starAward',label:'å›½çº§å¥–'},
        {key:'adminBonus',label:'ç®¡ç†å‘˜åŠ åˆ†'},
        {key:'volunteer',label:'å¿—æ„¿è€…'},
        {key:'goodDeed',label:'å¥½äººå¥½äº‹'},
        {key:'uniformViolation',label:'å†›å®¹ä¸æ•´'},
        {key:'phoneViolation',label:'è¿è§„æ‰‹æœº'},
        {key:'computerViolation',label:'è¿è§„ç”µè„‘'},
        {key:'smokingViolation',label:'è¿è§„æŠ½çƒŸ'},
        {key:'nightAbsence',label:'å¤œä¸å½’å®¿'},
        {key:'lateRise',label:'æœªåŠæ—¶èµ·åºŠ'},
        {key:'untimelyLeave',label:'æœªåŠæ—¶é”€å‡'}
    ];

    const elements = {
        studentPageBtn: document.getElementById('studentPageBtn'),
        schoolPageBtn: document.getElementById('schoolPageBtn'),
        studentPage: document.getElementById('studentPage'),
        schoolPage: document.getElementById('schoolPage'),
        studentClassSelect: document.getElementById('studentClass'),
        studentIdInput: document.getElementById('studentId'),
        studentLoginBtn: document.getElementById('studentLoginBtn'),
        studentInfoSection: document.getElementById('studentInfoSection'),
        studentLogoutBtn: document.getElementById('studentLogoutBtn'),
        displayName: document.getElementById('displayName'),
        displayStudentId: document.getElementById('displayStudentId'),
        displayClass: document.getElementById('displayClass'),
        displayIdentity: document.getElementById('displayIdentity'),
        todayTotalEl: document.getElementById('todayTotal'),
        monthlyTotalEl: document.getElementById('monthlyTotal'),
        totalScoreEl: document.getElementById('totalScore'),
        studentScoreHeader: document.getElementById('studentScoreHeader'),
        studentScoreBody: document.getElementById('studentScoreBody'),
        adminUsernameInput: document.getElementById('adminUsername'),
        adminPasswordInput: document.getElementById('adminPassword'),
        adminLoginBtn: document.getElementById('adminLoginBtn'),
        schoolManagementSection: document.getElementById('schoolManagementSection'),
        adminLogoutBtn: document.getElementById('adminLogoutBtn'),
        classListContainer: document.getElementById('classListContainer'),
        addClassBtn: document.getElementById('addClassBtn'),
        batchAddClassBtn: document.getElementById('batchAddClassBtn'),
        editClassSelect: document.getElementById('editClass'),
        editStudentIdInput: document.getElementById('editStudentId'),
        editNameInput: document.getElementById('editName'),
        editIdentitySelect: document.getElementById('editIdentity'),
        saveStudentBtn: document.getElementById('saveStudentBtn'),
        deleteStudentBtn: document.getElementById('deleteStudentBtn'),
        addStudentBtn: document.getElementById('addStudentBtn'),
        batchDeleteStudentsBtn: document.getElementById('batchDeleteStudentsBtn'),
        notification: document.getElementById('notification'),
        batchAddModal: document.getElementById('batchAddModal'),
        batchClassNamesTextarea: document.getElementById('batchClassNames'),
        closeBatchModal: document.getElementById('closeBatchModal'),
        confirmBatchAdd: document.getElementById('confirmBatchAdd'),
        cancelBatchAdd: document.getElementById('cancelBatchAdd'),
        historyDateInput: document.getElementById('historyDateInput'),
        queryHistoryBtn: document.getElementById('queryHistoryBtn'),
        historyDetailTable: document.getElementById('historyDetailTable'),
        historyMonthSelect: document.getElementById('historyMonthSelect'),
        queryMonthTotalBtn: document.getElementById('queryMonthTotalBtn'),
        monthTotalTable: document.getElementById('monthTotalTable'),
        adminActionNotice: document.getElementById('adminActionNotice'),
        onlineStudentsList: document.getElementById('onlineStudentsList'),
        adminTodayTotal: document.getElementById('adminTodayTotal'),
        adminScorePreviewBody: document.getElementById('adminScorePreviewBody'),
        syncStatus: document.getElementById('syncStatus'),
        dataStatus: document.getElementById('dataStatus')
    };

    // è¾…åŠ©å‡½æ•°
    function getToday() { 
        return new Date().toISOString().slice(0,10); 
    }
    
    function getCurrentMonth() { 
        return new Date().toISOString().slice(0,7); 
    }

    function getDefaultDayScore() {
        let obj = {};
        SCORE_FIELDS.forEach(f => obj[f.key] = 0);
        for(let k in AUTO_BASE) obj[k] = AUTO_BASE[k];
        return obj;
    }

    function calcTotal(scores){
        let add = 0, minus = 0;
        const minusKeys = ['Violation','Absence','Rise','Leave'];
        for(let k in scores){
            minusKeys.some(x => k.includes(x)) ? minus += scores[k] : add += scores[k];
        }
        return add - minus;
    }

    // æœˆæ€»åˆ†ï¼šæ²¡è®°å½•çš„å¤© = è‡ªåŠ¨5é¡¹æ»¡åˆ†ï¼ˆå€¼ç­0ï¼‰
    function calcRealMonthTotal(student, month) {
        const autoOneDay = 50; // å€¼ç­ä¸åŠ 
        let total = 0;
        const today = getToday();

        for(let date in student.dailyRecords){
            if(date.startsWith(month)){
                total += calcTotal(student.dailyRecords[date]);
            }
        }

        const year = parseInt(month.slice(0,4));
        const monthNum = parseInt(month.slice(5,7));
        const firstDay = new Date(year, monthNum-1, 1);
        const lastDay = new Date(year, monthNum, 0);

        let cur = new Date(firstDay);
        while(cur <= lastDay){
            const d = cur.toISOString().slice(0,10);
            if(d > today) break;
            if(!student.dailyRecords[d]) total += autoOneDay;
            cur.setDate(cur.getDate()+1);
        }
        return total;
    }

    // äº‘ç«¯APIå‡½æ•°
    async function loadDataFromCloud() {
        try {
            elements.syncStatus.textContent = 'æ­£åœ¨åŒæ­¥...';
            elements.syncStatus.classList.add('syncing');
            
            const response = await fetch(`${API_BASE_URL}/data`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            if (data.classes) {
                schoolData.classes = data.classes;
                updateSyncStatus(true);
                updateDataStatus();
                retryCount = 0;
                return true;
            }
        } catch (error) {
            console.log('ä»äº‘ç«¯åŠ è½½æ•°æ®å¤±è´¥:', error.message);
            updateSyncStatus(false);
            retryCount++;
            return false;
        }
    }

    async function saveDataToCloud() {
        try {
            elements.syncStatus.textContent = 'æ­£åœ¨ä¿å­˜...';
            elements.syncStatus.classList.add('syncing');
            
            const response = await fetch(`${API_BASE_URL}/data`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-Request-ID': Date.now()
                },
                body: JSON.stringify(schoolData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const result = await response.json();
            if (result.success) {
                updateSyncStatus(true);
                updateDataStatus();
                retryCount = 0;
                lastSyncTime = new Date();
                return true;
            }
        } catch (error) {
            console.log('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥:', error.message);
            updateSyncStatus(false);
            retryCount++;
            return false;
        }
    }

    // ä¿®æ”¹åçš„ loadData å‡½æ•°
    async function loadData() {
        const cloudSuccess = await loadDataFromCloud();
        
        if (!cloudSuccess) {
            console.log('äº‘ç«¯è¿æ¥å¤±è´¥ï¼Œå°è¯•ä»æœ¬åœ°åŠ è½½');
            const d = localStorage.getItem(STORAGE_KEY);
            if (d) {
                try {
                    schoolData = JSON.parse(d);
                } catch (e) {
                    console.log('æœ¬åœ°æ•°æ®æŸåï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
                    initDefault();
                }
            } else {
                initDefault();
            }
        }
        
        // åˆå§‹åŒ–æ•°æ®ç»“æ„
        schoolData.classes.forEach(cls => {
            cls.students.forEach(stu => {
                if(!stu.dailyRecords) stu.dailyRecords = {};
                if(!stu.monthlyTotalRecords) stu.monthlyTotalRecords = {};
            });
        });
    }

    // ä¿®æ”¹åçš„ saveData å‡½æ•°
    async function saveData() {
        const cloudSuccess = await saveDataToCloud();
        
        if (cloudSuccess) {
            // äº‘ç«¯ä¿å­˜æˆåŠŸåï¼Œä¹Ÿä¿å­˜åˆ°æœ¬åœ°ä½œä¸ºå¤‡ä»½
            localStorage.setItem(STORAGE_KEY, JSON.stringify(schoolData));
            showNotification("æ•°æ®ä¿å­˜æˆåŠŸ", "success");
            return true;
        } else {
            // äº‘ç«¯å¤±è´¥ï¼Œåªä¿å­˜åˆ°æœ¬åœ°
            localStorage.setItem(STORAGE_KEY, JSON.stringify(schoolData));
            showNotification("å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰", "info");
            return false;
        }
    }

    function updateSyncStatus(online) {
        isOnline = online;
        setTimeout(() => {
            if (online) {
                elements.syncStatus.textContent = 'å·²è¿æ¥äº‘ç«¯';
                elements.syncStatus.classList.remove('offline', 'syncing');
            } else {
                elements.syncStatus.textContent = 'ç¦»çº¿æ¨¡å¼';
                elements.syncStatus.classList.remove('syncing');
                elements.syncStatus.classList.add('offline');
            }
        }, 500);
    }

    function updateDataStatus() {
        const studentCount = schoolData.classes.reduce((total, cls) => total + cls.students.length, 0);
        const classCount = schoolData.classes.length;
        elements.dataStatus.textContent = `${classCount}ä¸ªç­çº§ ${studentCount}åå­¦ç”Ÿ`;
    }

    function initDefault(){
        schoolData = {
            classes: [{
                id: 1, 
                name: "è®¡ç®—æœº1ç­",
                students: [{
                    id: "001", 
                    name: "æµ‹è¯•å­¦ç”Ÿ", 
                    identity: "å­¦ç”Ÿ", 
                    dailyRecords: {},
                    monthlyTotalRecords: {}
                }]
            }]
        };
    }

    async function autoRefreshDaily() {
        const today = getToday();
        const last = localStorage.getItem(LAST_RUN_DATE);
        if(last === today) return;

        let needsSave = false;
        schoolData.classes.forEach(cls => {
            cls.students.forEach(stu => {
                if(!stu.dailyRecords[today]) {
                    stu.dailyRecords[today] = getDefaultDayScore();
                    needsSave = true;
                }
                const month = getCurrentMonth();
                stu.monthlyTotalRecords[month] = calcRealMonthTotal(stu, month);
            });
        });
        
        if (needsSave) {
            await saveData();
            localStorage.setItem(LAST_RUN_DATE, today);
        }
    }

    // å®šæœŸåŒæ­¥æ•°æ®
    function startAutoSync() {
        if (syncTimer) clearInterval(syncTimer);
        syncTimer = setInterval(async () => {
            if (currentState.adminLoggedIn || currentState.studentLoggedIn) {
                await loadDataFromCloud();
                if (currentState.studentLoggedIn) {
                    refreshStudent();
                }
                if (currentState.adminLoggedIn) {
                    renderClassList();
                }
            }
        }, SYNC_INTERVAL);
    }

    function showNotification(msg, type = "info"){
        elements.notification.textContent = msg;
        elements.notification.className = `notification ${type} show`;
        setTimeout(() => elements.notification.classList.remove("show"), 2800);
    }

    function renderClassList(){
        const container = elements.classListContainer;
        container.innerHTML = '';
        
        schoolData.classes.forEach(cls => {
            const div = document.createElement('div');
            div.className = 'class-item';
            div.innerHTML = `
                <div>${cls.name}ï¼ˆ${cls.students.length}äººï¼‰</div>
                <button class="del-class-btn" data-id="${cls.id}">åˆ é™¤</button>
            `;
            container.appendChild(div);
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            div.onclick = () => {
                document.querySelectorAll('.class-item').forEach(item => 
                    item.classList.remove('active'));
                div.classList.add('active');
                elements.editClassSelect.value = cls.id;
                loadAdminStudentScore();
            };
        });
        
        // åˆ é™¤æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.del-class-btn').forEach(btn => {
            btn.onclick = async (e) => {
                e.stopPropagation();
                if(!currentState.adminLoggedIn) {
                    return showNotification("è¯·å…ˆç™»å½•ç®¡ç†å‘˜", "error");
                }
                const id = +btn.dataset.id;
                const cls = schoolData.classes.find(x => x.id === id);
                if(!confirm(`ç¡®å®šåˆ é™¤ã€${cls.name}ã€‘ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
                
                schoolData.classes = schoolData.classes.filter(x => x.id !== id);
                await saveData();
                renderClassList();
                initAllSelect();
                showNotification("ç­çº§å·²åˆ é™¤", "success");
            };
        });
    }

    function initAllSelect(){
        // å­¦ç”ŸæŸ¥è¯¢é¡µé¢ç­çº§é€‰æ‹©
        elements.studentClassSelect.innerHTML = '<option value="">-- é€‰æ‹©ç­çº§ --</option>';
        schoolData.classes.forEach(c => {
            const o = document.createElement('option');
            o.value = c.id;
            o.textContent = c.name;
            elements.studentClassSelect.appendChild(o);
        });
        
        // ç®¡ç†é¡µé¢ç­çº§é€‰æ‹©
        elements.editClassSelect.innerHTML = '<option value="">-- é€‰æ‹©ç­çº§ --</option>';
        schoolData.classes.forEach(c => {
            const o = document.createElement('option');
            o.value = c.id;
            o.textContent = c.name;
            elements.editClassSelect.appendChild(o);
        });
    }

    function initMonthSelect(){
        const select = elements.historyMonthSelect;
        select.innerHTML = '<option value="">-- é€‰æ‹©æœˆä»½ --</option>';
        const stu = currentState.currentStudent;
        if(!stu) return;
        
        const months = Object.keys(stu.monthlyTotalRecords).sort().reverse();
        months.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m;
            opt.textContent = m;
            select.appendChild(opt);
        });
    }

    function loadAdminStudentScore() {
        const cid = +elements.editClassSelect.value;
        const sid = elements.editStudentIdInput.value.trim();
        
        if(!cid || !sid) { 
            clearAdminPreview(); 
            return; 
        }
        
        const cls = schoolData.classes.find(c => c.id === cid);
        const stu = cls?.students.find(s => s.id === sid);
        
        if(!stu) { 
            clearAdminPreview(); 
            return; 
        }
        
        elements.editNameInput.value = stu.name;
        elements.editIdentitySelect.value = stu.identity;
        const todayScore = stu.dailyRecords[getToday()] || getDefaultDayScore();
        
        SCORE_FIELDS.forEach(f => {
            const input = document.getElementById(`edit${f.key.charAt(0).toUpperCase()}${f.key.slice(1)}`);
            if(input) input.value = todayScore[f.key] || 0;
        });
        
        renderPreview(todayScore);
    }

    function clearAdminPreview(){
        elements.adminTodayTotal.textContent = "0";
        elements.adminScorePreviewBody.innerHTML = "";
        elements.editNameInput.value = "";
        elements.editIdentitySelect.value = "å­¦ç”Ÿ";
        
        SCORE_FIELDS.forEach(f => {
            const input = document.getElementById(`edit${f.key.charAt(0).toUpperCase()}${f.key.slice(1)}`);
            if(input) input.value = AUTO_BASE[f.key] || 0;
        });
    }

    function renderPreview(data){
        elements.adminTodayTotal.textContent = calcTotal(data);
        const body = elements.adminScorePreviewBody;
        body.innerHTML = '';
        
        SCORE_FIELDS.forEach(f => {
            const value = data[f.key] || 0;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${f.label}</td>
                <td class="${value >= 0 ? 'positive-score' : 'negative-score'}">${value}</td>
            `;
            body.appendChild(row);
        });
    }

    async function studentLogin(){
        const cid = +elements.studentClassSelect.value;
        const sid = elements.studentIdInput.value.trim();
        
        if(!cid || !sid) {
            return showNotification("è¯·é€‰æ‹©ç­çº§å¹¶è¾“å…¥å­¦å·", "error");
        }
        
        const cls = schoolData.classes.find(c => c.id === cid);
        if(!cls) return;
        
        const stu = cls.students.find(s => s.id === sid);
        if(!stu) return showNotification("å­¦å·ä¸å­˜åœ¨", "error");
        
        currentState.studentLoggedIn = true;
        currentState.currentStudent = stu;
        currentState.currentStudentClass = cls;
        
        if(!onlineStudents.includes(sid)) onlineStudents.push(sid);
        updateOnline();
        renderStudent();
        initMonthSelect();
        showNotification("ç™»å½•æˆåŠŸ", "success");
        
        // å¼€å§‹åŒæ­¥
        startAutoSync();
    }

    function renderStudent(){
        const stu = currentState.currentStudent;
        const cls = currentState.currentStudentClass;
        
        elements.displayName.textContent = stu.name;
        elements.displayStudentId.textContent = stu.id;
        elements.displayClass.textContent = cls.name;
        elements.displayIdentity.innerHTML = 
            `<span class="identity-badge ${IDENTITY_TYPES[stu.identity]}">${stu.identity}</span>`;
        
        const today = getToday();
        const todayData = stu.dailyRecords[today] || getDefaultDayScore();
        elements.todayTotalEl.textContent = calcTotal(todayData);
        
        const month = getCurrentMonth();
        const monthTotal = calcRealMonthTotal(stu, month);
        stu.monthlyTotalRecords[month] = monthTotal;
        elements.monthlyTotalEl.textContent = monthTotal;
        
        let total = 0;
        for(let m in stu.monthlyTotalRecords) {
            total += stu.monthlyTotalRecords[m];
        }
        elements.totalScoreEl.textContent = total;
        
        renderTodayTable(todayData);
        elements.studentInfoSection.classList.remove("hidden");
    }

    function renderTodayTable(data){
        const header = elements.studentScoreHeader;
        const body = elements.studentScoreBody;
        
        header.innerHTML = '<tr><th>é¡¹ç›®</th><th>åˆ†æ•°</th></tr>';
        body.innerHTML = '';
        
        SCORE_FIELDS.forEach(f => {
            const value = data[f.key] || 0;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${f.label}</td>
                <td class="${value >= 0 ? 'positive-score' : 'negative-score'}">${value}</td>
            `;
            body.appendChild(row);
        });
    }

    function queryHistory(){
        const date = elements.historyDateInput.value;
        const stu = currentState.currentStudent;
        
        if(!stu || !date) return;
        
        const data = stu.dailyRecords[date] || getDefaultDayScore();
        const thead = elements.historyDetailTable.querySelector('thead');
        const tbody = elements.historyDetailTable.querySelector('tbody');
        
        thead.innerHTML = `<tr><th colspan="2">${date} æ€»åˆ†ï¼š${calcTotal(data)}</th></tr>`;
        tbody.innerHTML = '';
        
        SCORE_FIELDS.forEach(f => {
            const value = data[f.key] || 0;
            tbody.innerHTML += `
                <tr>
                    <td>${f.label}</td>
                    <td class="${value >= 0 ? 'positive-score' : 'negative-score'}">${value}</td>
                </tr>
            `;
        });
    }

    function queryMonthTotal(){
        const month = elements.historyMonthSelect.value;
        const stu = currentState.currentStudent;
        
        if(!stu || !month) return;
        
        const total = calcRealMonthTotal(stu, month);
        const tbody = elements.monthTotalTable.querySelector('tbody');
        tbody.innerHTML = `<tr><td>${month}</td><td>${total}</td></tr>`;
    }

    async function saveStudent(){
        const cid = +elements.editClassSelect.value;
        const sid = elements.editStudentIdInput.value.trim();
        const name = elements.editNameInput.value.trim();
        
        if(!cid || !sid || !name) {
            return showNotification("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼ˆç­çº§ã€å­¦å·ã€å§“åï¼‰", "error");
        }
        
        const cls = schoolData.classes.find(c => c.id === cid);
        if(!cls) return;
        
        const scoreData = getDefaultDayScore();
        SCORE_FIELDS.forEach(f => {
            const input = document.getElementById(`edit${f.key.charAt(0).toUpperCase()}${f.key.slice(1)}`);
            if(input) scoreData[f.key] = +input.value || 0;
        });
        
        const today = getToday();
        const month = getCurrentMonth();
        
        let stu = cls.students.find(s => s.id === sid);
        if(stu) {
            // æ›´æ–°ç°æœ‰å­¦ç”Ÿ
            stu.name = name;
            stu.identity = elements.editIdentitySelect.value;
            stu.dailyRecords[today] = scoreData;
        } else {
            // æ·»åŠ æ–°å­¦ç”Ÿ
            cls.students.push({
                id: sid,
                name: name,
                identity: elements.editIdentitySelect.value,
                dailyRecords: { [today]: scoreData },
                monthlyTotalRecords: {}
            });
            stu = cls.students.find(s => s.id === sid);
        }
        
        stu.monthlyTotalRecords[month] = calcRealMonthTotal(stu, month);
        
        const success = await saveData();
        if(success) {
            renderClassList();
            initAllSelect();
            refreshStudent();
            updateOnline();
            loadAdminStudentScore();
        }
    }

    async function deleteStudent(){
        const cid = +elements.editClassSelect.value;
        const sid = elements.editStudentIdInput.value.trim();
        
        if(!cid || !sid) {
            return showNotification("è¯·é€‰æ‹©ç­çº§å¹¶è¾“å…¥å­¦å·", "error");
        }
        
        const cls = schoolData.classes.find(c => c.id === cid);
        if(!cls) return;
        
        const stu = cls.students.find(s => s.id === sid);
        if(!stu) return;
        
        if(!confirm(`ç¡®å®šåˆ é™¤å­¦ç”Ÿ ${stu.name}ï¼ˆ${stu.id}ï¼‰ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
        
        cls.students = cls.students.filter(s => s.id !== sid);
        
        const success = await saveData();
        if(success) {
            renderClassList();
            initAllSelect();
            clearAdminPreview();
            refreshStudent();
            updateOnline();
        }
    }

    function refreshStudent(){
        if(currentState.studentLoggedIn && currentState.currentStudent){
            renderStudent();
            elements.adminActionNotice.classList.remove('hidden');
            setTimeout(() => elements.adminActionNotice.classList.add('hidden'), 5000);
        }
    }

    function updateOnline(){
        const list = elements.onlineStudentsList;
        list.innerHTML = '';
        
        onlineStudents.forEach(sid => {
            let name = sid;
            for(const cls of schoolData.classes){
                const stu = cls.students.find(s => s.id === sid);
                if(stu){
                    name = stu.name;
                    break;
                }
            }
            const li = document.createElement('li');
            li.textContent = `${name}ï¼ˆ${sid}ï¼‰`;
            list.appendChild(li);
        });
    }

    // ç»‘å®šäº‹ä»¶
    function bind(){
        elements.studentLoginBtn.onclick = studentLogin;
        
        elements.studentLogoutBtn.onclick = () => {
            if(currentState.currentStudent) {
                onlineStudents = onlineStudents.filter(id => id !== currentState.currentStudent.id);
            }
            currentState = {
                ...currentState,
                studentLoggedIn: false,
                currentStudent: null
            };
            elements.studentInfoSection.classList.add("hidden");
            updateOnline();
        };
        
        elements.queryHistoryBtn.onclick = queryHistory;
        elements.queryMonthTotalBtn.onclick = queryMonthTotal;
        
        elements.editClassSelect.onchange = loadAdminStudentScore;
        elements.editStudentIdInput.oninput = loadAdminStudentScore;
        
        elements.adminLoginBtn.onclick = () => {
            if(elements.adminUsernameInput.value === "admin" && 
               elements.adminPasswordInput.value === "admin123"){
                currentState.adminLoggedIn = true;
                elements.schoolManagementSection.classList.remove("hidden");
                renderClassList();
                initAllSelect();
                updateOnline();
                startAutoSync();
                showNotification("ç®¡ç†å‘˜ç™»å½•æˆåŠŸ", "success");
            } else {
                showNotification("è´¦å·å¯†ç é”™è¯¯", "error");
            }
        };
        
        elements.adminLogoutBtn.onclick = () => {
            currentState.adminLoggedIn = false;
            elements.schoolManagementSection.classList.add("hidden");
        };
        
        elements.saveStudentBtn.onclick = saveStudent;
        elements.deleteStudentBtn.onclick = deleteStudent;
        
        elements.addClassBtn.onclick = async () => {
            const className = prompt("è¯·è¾“å…¥ç­çº§åç§°ï¼š");
            if(!className) return;
            
            const newId = schoolData.classes.length > 0 
                ? Math.max(...schoolData.classes.map(x => x.id)) + 1 
                : 1;
            
            schoolData.classes.push({
                id: newId,
                name: className,
                students: []
            });
            
            await saveData();
            renderClassList();
            initAllSelect();
        };
        
        elements.batchAddClassBtn.onclick = () => {
            elements.batchAddModal.classList.add("show");
        };
        
        elements.closeBatchModal.onclick = elements.cancelBatchAdd.onclick = () => {
            elements.batchAddModal.classList.remove("show");
        };
        
        elements.confirmBatchAdd.onclick = async () => {
            const classNames = elements.batchClassNamesTextarea.value
                .trim()
                .split("\n")
                .filter(name => name.trim());
            
            if(classNames.length === 0) {
                return showNotification("è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªç­çº§åç§°", "error");
            }
            
            let nextId = schoolData.classes.length > 0 
                ? Math.max(...schoolData.classes.map(x => x.id)) + 1 
                : 1;
            
            classNames.forEach(name => {
                schoolData.classes.push({
                    id: nextId++,
                    name: name.trim(),
                    students: []
                });
            });
            
            await saveData();
            renderClassList();
            initAllSelect();
            elements.batchAddModal.classList.remove("show");
            showNotification(`æˆåŠŸå¯¼å…¥ ${classNames.length} ä¸ªç­çº§`, "success");
        };
        
        elements.studentPageBtn.onclick = () => {
            elements.studentPage.classList.add("active");
            elements.schoolPage.classList.remove("active");
            elements.studentPageBtn.classList.add("active");
            elements.schoolPageBtn.classList.remove("active");
        };
        
        elements.schoolPageBtn.onclick = () => {
            elements.schoolPage.classList.add("active");
            elements.studentPage.classList.remove("active");
            elements.schoolPageBtn.classList.add("active");
            elements.studentPageBtn.classList.remove("active");
        };
    }

    async function init(){
        try {
            await loadData();
            await autoRefreshDaily();
            initAllSelect();
            bind();
            startAutoSync();
            updateDataStatus();
        } catch (error) {
            console.error('åˆå§‹åŒ–å¤±è´¥:', error);
            showNotification("ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢", "error");
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>